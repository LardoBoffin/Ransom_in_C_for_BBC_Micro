/* Functions for DOS based file handling
   Will need attention for CPM              */


/*-------------------------- file handling -------------------------*/
long readIndex(int recordNumber, char *fileName)
{
 /* reads an integer from the index file */

 long index;
 int number;

 FILE *fileptr;
 index=(((long)recordNumber-1)*5)+3;
 number=0;

 fileptr=fopen(fileName,"rb");
 if (fileptr==NULL) { printf("Null file pointer in index");return 0;}

 fseek(fileptr,index,SEEK_SET);
 number=fgetc(fileptr)*256;
 number=number+fgetc(fileptr);
 fclose(fileptr);
 return (long)number;

}

void loadSystemMessages()
{
   long index;
   int i,c,o,l;
   FILE *fileptr;
   fileptr=fopen(messageLoc,"rb");

   if (fileptr==NULL) { printf("Null file pointer in system message");return;}
   /* get the index of message 19 as this will be the end of message 18 */

   index=readIndex(numSysMessages,(char *)messageIndexLoc);

   sysMessages=(char *)malloc(((int)index)*sizeof(char));
   fread(sysMessages,(int)index,1,fileptr);
   fclose(fileptr);

   c=0;
   while (c<index){
    i=sysMessages[c];c=c+1;l=sysMessages[c];
    reverse(sysMessages,c+1,l);

    /* step through each character of the word based on length */
    o=1;
    while (o<l+1){
      c++;o++;
    }
    putchar('.');
    c++;/*start of next word*/
 }
}

void getMessage(int number)
{
   long index;
   FILE *fileptr;
   int msgLen,x,y,num,start,end;

   memset(&message[0],'\0',sizeof(message));

   if (number < numSysMessages){
    /* start with first message and step through */
    /* until the correct number is found */

    end=1;
    for (num=1;num<=number;num++)
    {
       msgLen=sysMessages[end]; /* len of current message */
       end=end+msgLen+2;
    }
    start=end-msgLen;
    end--;

    for (x=0,y=start-1;x<msgLen;x++,y++)
    {
      message[x]=sysMessages[y];
    }
    message[x]='\0';

   }else{

    fileptr=fopen(messageLoc,"rb");
    index=readIndex(number,(char *)messageIndexLoc);
    fseek(fileptr,index,SEEK_SET);
    fgetc(fileptr);
    msgLen=(int)fgetc(fileptr);
    fread(message,msgLen,1,fileptr);
    fclose(fileptr);
    reverse(message,0,msgLen);
    message[msgLen]='\0';
   }
}

void loadWords(int type)
{
 /* file format is:

    first byte = item number
    second byte = 0
    third byte = length of text
    fourth byte onwards = word in reverse order

 */

 FILE *fileptr;
 long filelen;
 int c,i,l,o;

 /* open the object file, jump to the end to get its size*/
 /* and then return to the start*/
 if (type==NOUN) fileptr=fopen(nounLoc,"rb");
 if (type==VERB) fileptr=fopen(verbLoc,"rb");
 if (type==ADVERB) fileptr=fopen(adverbLoc,"rb");

 if (fileptr==NULL) { printf("Null file pointer in load words");return;}

 fseek(fileptr,0, SEEK_END);
 filelen=ftell(fileptr);
 rewind(fileptr);

 /*resize the objects array*/
 if (type==NOUN){
   nounNumber=(int)filelen;
   nouns=(char *)malloc(((int)filelen+1)*sizeof(char));
   /*read in the whole of the file*/
   fread(nouns,(int)filelen,1,fileptr);

   /*print out the text*/
   c=0;
   while (c<filelen)
   {
      i=nouns[c];c=c+2;l=nouns[c];
      reverseUpper(nouns,c+1,l);

      /* step through each character of the word based on length */
      o=1;
      while (o<l+1){
          c++;o++;
      }
      putchar('.');
      c++;/*start of next word*/
   }
 }

 if (type==VERB){
   verbNumber=(int)filelen;
   verbs=(char *)malloc(((int)filelen+1)*sizeof(char));
   /*read in the whole of the file*/
   fread(verbs,(int)filelen,1,fileptr);

   /*print out the text*/
   c=0;
   while (c<filelen)
   {
      i=verbs[c];c=c+2;l=verbs[c];
      reverseUpper(verbs,c+1,l);

      /* step through each character of the word based on length */
      o=1;
      while (o<l+1){
         c++;o++;
      }
      putchar('.');
      c++;/*start of next word*/
   }
 }

if (type==ADVERB){
   adverbNumber=(int)filelen;
   adverbs=(char *)malloc(((int)filelen+1)*sizeof(char));
   /*read in the whole of the file*/
   fread(adverbs,(int)filelen,1,fileptr);

   /*print out the text*/
   c=0;
   while (c<filelen)
   {
       i=adverbs[c];c=c+2;l=adverbs[c];
       reverseUpper(adverbs,c+1,l);

       /* step through each character of the word based on length */
       o=1;
       while (o<l+1){
         c++;o++;
       }
       putchar('.');
       c++;/*start of next word*/
   }
 }

 fclose(fileptr);

}

int loadObjects()
{
 FILE *fileptr;
 long filelen;
 /*int c,i,o; */
 /* open the object file, jump to the end to get its size*/
 /* and then return to the start*/
 fileptr=fopen(objectLoc,"rb");
 if (fileptr==NULL) {printf("Unable to find the objects file."); return 1;}
 fseek(fileptr,0, SEEK_END);
 filelen=ftell(fileptr);
 rewind(fileptr);

 /*resize the objects array*/
 objectList=(char *)malloc(((int)filelen+1)*sizeof(char));
 /*read in the whole of the file*/
 fread(objectList,(int)filelen,1,fileptr);
 fclose(fileptr);
 objn=(int)filelen/8;
 return 0;
}


void loadAchievements()
{

 FILE *fileptr;
 long filelen;
 /*int c,i,o; */
 /* open the object file, jump to the end to get its size*/
 /* and then return to the start*/
 fileptr=fopen((char *)achievementIndexLoc,"rb");
 fseek(fileptr,0, SEEK_END);
 filelen=ftell(fileptr);
 rewind(fileptr);

 /*resize the objects array*/
 ach=(char *)malloc(((int)filelen+1)*sizeof(char));
 /*read in the whole of the file*/
 fread(ach,(int)filelen,1,fileptr);
 fclose(fileptr);
 achn=(int)filelen;

}


void saveAchievements()
{
  FILE *fileptr;
  fileptr=fopen((char *)achievementIndexLoc,"w");
  if (fileptr==NULL)
  {printf("Unable to save achievements!\n");return;}
  fwrite(ach,achn,1,fileptr);
  fclose(fileptr);

}


void saveGame(){

  /* message contains the save string. e.g. save game01 */
  /* or just save and then save as save-m */

  int i,c;
  FILE *fileptr;
  printf("Saving game...");
  fileptr=fopen("save-m","w");
  if (fileptr==NULL)
  {
    printf("Could not save game!\n");
    return;
  }
  /* save the game variables */
  fwrite(&turn, sizeof(int),1,fileptr);
  fwrite(&room, sizeof(int),1,fileptr);
  fwrite(&enc, sizeof(int),1,fileptr);
  fwrite(&cw, sizeof(int),1,fileptr);
  fwrite(&clear, sizeof(int),1,fileptr);

  /*save the counter values */
  for (i=0;i<counterSize;i++)
  {
    c=ctr[i];

    fputc(c,fileptr);
  }

  /*save objects */
  fwrite(objectList,(objn*8),1,fileptr);

  fclose(fileptr);
  saveAchievements();
  printf("\nDone.\n");

}

void loadGame()
{

  int i;
  FILE *fileptr;
  printf("Loading game...");
  fileptr=fopen("save-m","rb");
  if (fileptr==NULL)
  {
    printf("Could not load game!\n");
    return;
  }
  fread(&turn, sizeof(int),1,fileptr);
  fread(&room, sizeof(int),1,fileptr);
  fread(&enc, sizeof(int),1,fileptr);
  fread(&cw, sizeof(int),1,fileptr);
  fread(&clear, sizeof(int),1,fileptr);

  /* load counters */
  for (i=0;i<counterSize;i++)
  {ctr[i]=fgetc(fileptr);}

  /* load objects */
  fread(objectList,(objn*8),1,fileptr);

  fclose(fileptr);

  printf("\nDone.\n");

}

/*----------------- display functions -------------------*/


void showMessage(int number)
{
   /* load and display a message*/

   int x,xpos,slen,wl,printLoop;

   getMessage(number);
   slen=strlen(message);
   xpos=pos(XPOS); /*position across screen */

   x=0;

   while (x<slen){
     wl=0;

     /* get the next word (or end of string)*/
     while (message[x+wl]!=' ' && x+wl < slen)
     {wl++;}

     if (xpos + wl > screenWidth )
     {putchar('\n');xpos=0;}

     /* print out the word */
     for (printLoop=0;printLoop<wl;printLoop++,x++)
     {putchar(message[x]);}

     xpos=xpos+wl+1;/* +1 for the space */

     if (xpos < screenWidth && xpos > 0) /* no space at end or start of line*/
	 {putchar(' ');}else{xpos--;}
     x++;
   }

   message[0]='\0';

}





